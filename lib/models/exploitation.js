import {ObjectId} from 'mongodb'
import createHttpError from 'http-errors'
import mongo from '../util/mongo.js'
import {getNextSeqId} from '../util/sequences.js'

export async function getExploitationsFromPointId(pointId) {
  return mongo.db.collection('exploitations').find(
    {
      point: pointId,
      deletedAt: {$exists: false}
    }
  ).toArray()
}

export async function getExploitation(exploitationId) {
  return mongo.db.collection('exploitations').findOne(
    {
      _id: exploitationId,
      deletedAt: {$exists: false}
    }
  )
}

export async function getExploitationBySeqId(codeTerritoire, idExploitation) {
  return mongo.db.collection('exploitations').findOne(
    {id_exploitation: idExploitation, territoire: codeTerritoire}
  )
}

export async function pointHasActiveExploitation(pointId) {
  const count = await mongo.db.collection('exploitations').countDocuments({
    point: pointId,
    statut: 'En activité',
    deletedAt: {$exists: false}
  })

  return count > 0
}

/* Insertion (utilisé par le service) */

export async function insertExploitation(exploitation, codeTerritoire) {
  const nextId = await getNextSeqId(`territoire-${codeTerritoire}-exploitations`)

  exploitation._id = new ObjectId()
  exploitation.id_exploitation = nextId
  exploitation.territoire = codeTerritoire
  exploitation.createdAt = new Date()
  exploitation.updatedAt = new Date()

  await mongo.db.collection('exploitations').insertOne(exploitation)

  return exploitation
}

/* Mise à jour par ID (utilisé par le service) */

export async function updateExploitationById(exploitationId, changes) {
  if (!changes || typeof changes !== 'object') {
    throw createHttpError(400, 'Les modifications doivent être un objet.')
  }

  const update = {
    ...changes,
    updatedAt: new Date()
  }

  const exploitation = await mongo.db.collection('exploitations').findOneAndUpdate(
    {_id: exploitationId, deletedAt: {$exists: false}},
    {$set: update},
    {returnDocument: 'after'}
  )

  if (!exploitation) {
    throw createHttpError(404, 'Cette exploitation est introuvable.')
  }

  return exploitation
}

/* Requêtes liées aux préleveurs */

export async function preleveurHasExploitations(preleveurId) {
  const count = await mongo.db.collection('exploitations').countDocuments({
    preleveur: preleveurId,
    deletedAt: {$exists: false}
  })

  return count > 0
}

export async function getPreleveurExploitations(preleveurId, projection) {
  return mongo.db.collection('exploitations').find(
    {preleveur: preleveurId, deletedAt: {$exists: false}},
    {projection}
  ).toArray()
}

export async function getPreleveurExploitationsViaPoints(preleveurId, projection) {
  // 1) points uniques liés aux exploitations du préleveur
  const points = await mongo.db.collection('exploitations').distinct('point', {
    preleveur: preleveurId,
    deletedAt: {$exists: false},
    point: {$exists: true, $ne: null}
  })

  if (points.length === 0) {
    return []
  }

  // 2) exploitations candidates via ces points
  return mongo.db.collection('exploitations').find(
    {
      point: {$in: points},
      deletedAt: {$exists: false}
    },
    {projection}
  ).toArray()
}

/* Requêtes liées aux documents */

export async function exploitationHasDocument(documentId) {
  const count = await mongo.db.collection('exploitations').countDocuments({
    documents: documentId,
    deletedAt: {$exists: false}
  })

  return count > 0
}

export async function deleteExploitation(exploitationId) {
  return mongo.db.collection('exploitations').findOneAndUpdate(
    {_id: exploitationId, deletedAt: {$exists: false}},
    {$set: {
      deletedAt: new Date(),
      updatedAt: new Date()
    }},
    {returnDocument: 'after'}
  )
}

export async function bulkInsertExploitations(codeTerritoire, exploitations) {
  if (exploitations.length === 0) {
    return {insertedCount: 0}
  }

  const exploitationsToInsert = exploitations.map(exploitation => ({
    ...exploitation,
    territoire: codeTerritoire,
    createdAt: new Date(),
    updatedAt: new Date()
  }))

  const {insertedCount} = await mongo.db.collection('exploitations').insertMany(exploitationsToInsert)

  return {insertedCount}
}

export async function bulkDeleteExploitations(codeTerritoire) {
  await mongo.db.collection('exploitations').deleteMany({territoire: codeTerritoire})
}
