import {
  createExploitation,
  updateExploitation,
  deleteExploitation,
  decorateExploitation
} from '../services/exploitation.js'

import {
  decorateDocument
} from '../services/document.js'

import {
  getDocument
} from '../models/document.js'

// Création d'une exploitation
export async function createExploitationHandler(req, res) {
  const exploitation = await createExploitation(req.body)
  const decoratedExploitation = await decorateExploitation(exploitation)

  res.send(decoratedExploitation)
}

// Détail d'une exploitation
export async function getExploitationDetail(req, res) {
  const decoratedExploitation = await decorateExploitation(req.exploitation)

  res.send(decoratedExploitation)
}

// Mise à jour d'une exploitation
export async function updateExploitationHandler(req, res) {
  const exploitation = await updateExploitation(req.exploitation._id, req.body)
  const decoratedExploitation = await decorateExploitation(exploitation)

  res.send(decoratedExploitation)
}

// Suppression d'une exploitation
export async function deleteExploitationHandler(req, res) {
  const deletedExploitation = await deleteExploitation(req.exploitation._id)

  res.send(deletedExploitation)
}

// Liste des documents d'une exploitation
export async function getExploitationDocuments(req, res) {
  const documentsPromises = (req.exploitation.documents || []).map(docId => getDocument(docId))
  const documentsResults = await Promise.all(documentsPromises)
  const documents = documentsResults.filter(Boolean)
  const decoratedDocuments = await Promise.all(documents.map(d => decorateDocument(d)))

  res.send(decoratedDocuments)
}
