enum SourceType {
  DECLARATION
  BATCH
  API
}

enum SourceStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Source {
  id     String       @id @default(uuid()) @db.Uuid
  type   SourceType
  status SourceStatus @default(PENDING)

  metadata Json?

  declarationId String      @unique @db.Uuid
  declaration   Declaration @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  chunks Chunk[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([declarationId])
}

enum ChunkInstructionStatus {
  PENDING
  REJECTED
  VALIDATED
  AUTOMATICALLY_VALIDATED
}

model Chunk {
  id String @id @default(uuid()) @db.Uuid

  sourceId String @db.Uuid
  source   Source @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Nom brut (ex. "Source du Golley") si point non encore li√©
  pointPrelevementName String? @db.Text

  pointPrelevementId String?           @db.Uuid
  pointPrelevement   PointPrelevement? @relation(fields: [pointPrelevementId], references: [id], onDelete: SetNull)

  instructionStatus            ChunkInstructionStatus @default(PENDING)
  instructedAt                 DateTime?
  instructedByInstructorUserId String?                @db.Uuid
  instructedByInstructor       Instructor?            @relation(fields: [instructedByInstructorUserId], references: [userId])
  instructionComment           String?                @db.Text

  parsingInfo Json @default("{}")

  minDate DateTime @db.Date
  maxDate DateTime @db.Date

  extras Json @default("{}")

  chunkValues ChunkValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instructionStatus])
}

model ChunkValue {
  id String @id @default(uuid()) @db.Uuid

  chunkId String @db.Uuid
  chunk   Chunk  @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  metricTypeCode String  @db.Text
  unit           String? @db.Text
  frequency      String  @db.Text

  date  DateTime @db.Date
  value Decimal  @db.Decimal(20, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([metricTypeCode])
}
